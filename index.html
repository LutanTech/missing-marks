<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Moi University Missing Marks Submission Portal | Official Student Claims System</title>
    
    <meta name="description" content="The official Moi University Missing Marks Submission Portal. Securely submit and track missing exam marks claims online. Built and maintained by Lutan Tech Systems.">
    <meta name="keywords" content="Moi University, missing marks portal, MU results, exam claims, student grades, university results Kenya, Moi University portal, Lutan Tech">
    <meta name="author" content="Lutan Tech Systems">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#0a2a66">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Moi University Missing Marks Submission Portal">
    <meta property="og:description" content="Official platform for Moi University students to submit and follow up on missing exam marks securely online.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Moi University Missing Marks Portal">
    <meta property="og:image" content="https://missing-marks-mu.vercel.app/assets/icons/og-image.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:url" content="https://missing-marks-mu.vercel.app/">
    <meta property="og:locale" content="en_KE">
    <meta name="google-site-verification" content="not5v-5IXFKweoEs5JQcKIMxrUab_JHpA0x5DEVo8io" />
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Moi University Missing Marks Portal">
    <meta name="twitter:description" content="Submit and track missing marks claims at Moi University using the official online portal.">
    <meta name="twitter:image" content="https://missing-marks-mu.vercel.app/assets/icons/og-image.png">
    
    <!-- Icons -->
    <link rel="icon" href="/assets/icons/logo-2.png" type="image/png">
    <link rel="apple-touch-icon" href="/assets/icons/icon.png">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Performance -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <meta name="monetag" content="0b4a984303a0b5ba4008a12d57e8318e">
    <script>(function(s){s.dataset.zone='10491952',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>

</head>
<body>

<div class="content">
    <div class="card">
        <div class="header">
            <div class="logo-holder">
                <img src="https://portal.mu.ac.ke/assets/images/logo2.png" alt="Logo">
            </div>
            <h1 id="mainTitle">Missing Marks Form</h1>
            <div class="step-indicator" id="stepIndicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>
        </div>

        <form id="multiStepForm">
            <!-- Step 1: Identity -->
            <div class="step-content active" data-step="1">
                <div class="form-group">
                    <label>Registration Number</label>
                    <input type="text" id="admNumber" placeholder="e.g. BA/0000/23" required>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="name" placeholder="As per Student ID" required>
                </div>
                <div class="form-group">
                    <label>Course Code(s) <small>(Comma separated: LMC 110, BAS 101)</small></label>
                    <textarea id="courseCodes" placeholder="Enter codes separated by commas" required></textarea>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-next" onclick="nextStep(2)">Next: Course Details</button>
                </div>
                <hr>
                <a href="/view" class="view-link"> View Submitted</a>
            </div>

            <!-- Step 2: Course Details (Dynamic) -->
            <div class="step-content" data-step="2">
                <div id="dynamicCourseContainer">
                    <!-- Dynamic fields injected here -->
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" onclick="prevStep(1)">Back</button>
                    <button type="button" class="btn btn-next" onclick="nextStep(3)">Next: Final Review</button>
                </div>
            </div>

            <!-- Step 3: Submission -->
            <div class="step-content" data-step="3">
                <div id="summaryContainer">
                    <!-- Summary injected here -->
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" onclick="prevStep(2)">Back</button>
                    <button type="submit" class="btn btn-next" id="submitBtn">Confirm & Submit</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="overlay" id="overlay">
    <div class="modal">
        <h2 id="modalTitle"></h2>
        <p id="modalMsg"></p>
        <button class="btn btn-prev" style="margin-top:20px" onclick="closeModal()">Close</button>
    </div>
</div>

<footer>
    <p style="color: #94a3b8; font-size: 0.85rem;">&copy; 2026 <a href="https://lutan-tech.is-great.org/?utm_source=missing_marks&utm_medium=direct" target="_blank">Lutan Tech</a></p>
    <div class="flag-line">
        <div style="flex:1; background:black"></div>
        <div style="flex:1; background:var(--kenya-red)"></div>
        <div style="flex:1; background:var(--deep-green)"></div>
    </div>
    <hr>
    <div class="version">Version 2.0.0. View <a href="/releases">Changelog</a></div>

</footer>

<script>
    const API_URL = "https://missingmarks.eu.pythonanywhere.com/submission/missing-marks";
    let currentStep = 1;
    let courseList = [];

    const storageKey = 'missing_marks_draft';

    function saveToDraft() {
        const formData = {
            admNumber: document.getElementById('admNumber').value,
            name: document.getElementById('name').value,
            courseCodes: document.getElementById('courseCodes').value,
            dynamicData: {}
        };

        const dynamicInputs = document.querySelectorAll('#dynamicCourseContainer input, #dynamicCourseContainer select');
        dynamicInputs.forEach(input => {
            formData.dynamicData[input.id] = input.value;
        });

        localStorage.setItem(storageKey, JSON.stringify(formData));
    }

    function loadDraft() {
        const saved = localStorage.getItem(storageKey);
        if (!saved) return;

        const data = JSON.parse(saved);
        document.getElementById('admNumber').value = data.admNumber || '';
        document.getElementById('name').value = data.name || '';
        document.getElementById('courseCodes').value = data.courseCodes || '';
        
        if(data.courseCodes) buildDynamicStep();
        
        Object.keys(data.dynamicData || {}).forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = data.dynamicData[id];
        });
    }

    function buildDynamicStep() {
        const codesRaw = document.getElementById('courseCodes').value;
        courseList = codesRaw.split(',').map(c => c.trim()).filter(c => c.length > 0);
        
        const container = document.getElementById('dynamicCourseContainer');
        container.innerHTML = `<h3>Enter details for ${courseList.length} course(s)</h3>`;

        courseList.forEach((code, index) => {
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            row.innerHTML = `
                <h4>COURSE: ${code.toUpperCase()}</h4>
                <div class="form-group">
                    <label>${code} Title</label>
                    <input type="text" id="title_${index}" placeholder="e.g. Introduction to Communication" required oninput="saveToDraft()">
                </div>
                <div class="ses-lec">
                    <div class="form-group">
                        <label>Session</label>
                        <select id="session_${index}" required onchange="saveToDraft()">
                            <option value="NORMAL">Normal</option>
                            
                            <option value="SUP">Supplementary</option>
                            <option value="SPECIAL">Special</option>
                            <option value="CAT">CAT Marks</option>
                            <option value="RETAKE">Retake Exam</option>
                            <option value="RETAKE_CAT">Retake CAT Marks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lecturer</label>
                        <input type="text" id="lec_${index}" placeholder="Name" required oninput="saveToDraft()">
                    </div>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function buildSummary() {
        const container = document.getElementById('summaryContainer');
        let html = `<h3>Review Submission</h3>
                    <p><strong>Adm:</strong> ${document.getElementById('admNumber').value}</p>
                    <p><strong>Name:</strong> ${document.getElementById('name').value}</p>
                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">`;

        courseList.forEach((code, index) => {
            const title = document.getElementById(`title_${index}`).value;
            const session = document.getElementById(`session_${index}`).value;
            const lec = document.getElementById(`lec_${index}`).value;
            html += `<div style="text-align:left; font-size:0.9rem; margin-bottom:10px; border-left:3px solid var(--accent-green); padding-left:10px">
                        <strong>${code.toUpperCase()}</strong>: ${title}<br>
                        <small>${session} | Lecturer: ${lec}</small>
                     </div>`;
        });
        container.innerHTML = html;
    }

    function nextStep(step) {
        if (step === 2) {
            if (!document.getElementById('admNumber').value || !document.getElementById('courseCodes').value) {
                showModal( 'Error',"Please fill in basic info and course codes first.",'error');
                return;
            }
            buildDynamicStep();
        }
        if (step === 3) {
            const inputs = document.querySelectorAll('#dynamicCourseContainer input');
            let valid = true;
            inputs.forEach(i => { if(!i.value) valid = false; });
            if(!valid) { showModal('Error', "Please complete all course details.", 'error'); return; }
            buildSummary();
        }

        currentStep = step;
        updateUI();
        saveToDraft();
    }

    function prevStep(step) {
        currentStep = step;
        updateUI();
    }

    function updateUI() {
        document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
        
        const dots = document.querySelectorAll('.step-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i < currentStep);
        });
    }

    function showModal(title, msg, type='info') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        document.getElementById('overlay').classList.add('active');
        document.getElementById('overlay').classList.add(`ov-${type}`);
    }

    function closeModal() {
        document.getElementById('overlay').classList.remove('active');
    }

    document.getElementById('multiStepForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Submitting...";

        const payload = {
            admNumber: document.getElementById('admNumber').value.toUpperCase(),
            name: document.getElementById('name').value.toUpperCase(),
            courseCode: courseList.join(', ').toUpperCase(),
            courseTitle: courseList.map((_, i) => document.getElementById(`title_${i}`).value.toUpperCase()).join(', '),
            session: courseList.map((_, i) => document.getElementById(`session_${i}`).value).join(', '),
            lecturerName: courseList.map((_, i) => document.getElementById(`lec_${i}`).value.toUpperCase()).join(', ')
        };

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                showModal("Success!", "Your missing marks claim has been submitted successfully.", 'success');
                localStorage.removeItem(storageKey);
                document.getElementById('multiStepForm').reset();
                setTimeout(() => location.reload(), 3000);
            } else {
                showModal("Error", "There was an issue with the submission. Please try again.", 'error');
            }
        } catch (err) {
            showModal("Network Error", "Could not reach the server. Please check your connection.", 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirm & Submit";
        }
    });

    window.onload = loadDraft;
    document.querySelectorAll('#admNumber, #name, #courseCodes').forEach(el => {
        el.addEventListener('input', saveToDraft);
    });
</script>
</body>
</html>