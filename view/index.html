<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>View Claims | Moi University Missing Marks Portal</title>

    <!-- SEO Basics -->
    <meta name="description" content="View and track your submitted missing marks claims on the official Moi University Missing Marks Submission Portal. Fast, secure, and student friendly.">
    <meta name="keywords" content="Moi University, view claims, missing marks status, exam claims tracking, MU student portal, missing results Kenya">
    <meta name="author" content="Lutan Tech Systems">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#0a2a66">

    <!-- Open Graph -->
    <meta property="og:title" content="View Claims | Moi University Missing Marks Portal">
    <meta property="og:description" content="Check the status of your missing exam marks claims through the official Moi University student portal.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Moi University Missing Marks Portal">
    <meta property="og:image" content="https://missing-marks-mu.vercel.app/assets/icons/og-image.png">
    <meta property="og:url" content="https://missing-marks-mu.vercel.app/view-claims">
    <meta property="og:locale" content="en_KE">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="View Claims | Moi University Missing Marks">
    <meta name="twitter:description" content="Track and monitor your missing marks submissions at Moi University in real time.">
    <meta name="twitter:image" content="https://missing-marks-mu.vercel.app/assets/icons/og-image.png">

    <!-- Icons -->
    <link rel="icon" href="/assets/icons/logo-2.png" type="image/png">
    <link rel="apple-touch-icon" href="/assets/icons/icon.png">
    <link rel="manifest" href="/manifest.json">

    <!-- Performance -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="format-detection" content="telephone=no">

    <!-- Styles -->
    <link rel="stylesheet" href="/view/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

    <div class="container">
        <div class="top-nav">
            <div class="header-main">
                <h1>View Claims</h1>
                <p>Track the status of your reported missing marks</p>
            </div>
            <a href="/" class="back-link">
                <i class="fas fa-arrow-left"></i>
                New Submission
            </a>
        </div>

        <div class="search-card">
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label>
                        <i class="fas fa-id-card"></i>
                        Admission Number
                    </label>
                    <input 
                        type="text" 
                        id="searchAdm" 
                        placeholder="e.g. LMC/0327/23" 
                        required 
                    >
                </div>
                <button type="submit" id="searchBtn" class="btn-search">
                    <i class="fas fa-magnifying-glass"></i>
                    <span>Fetch Records</span>
                </button>
            </form>
        </div>

        <div id="resultsArea" class="results-section">
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>Enter your admission number above to retrieve your claim history.</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:7820/submissions";

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const adm = document.getElementById('searchAdm').value.trim().toUpperCase();
            const btn = document.getElementById('searchBtn');
            const btnText = btn.querySelector('span');
            const btnIcon = btn.querySelector('i');
            const results = document.getElementById('resultsArea');

            btn.disabled = true;
            btnText.innerText = "Searching...";
            btnIcon.className = "fas fa-circle-notch fa-spin";

            try {
                const response = await fetch(`${API_BASE}?admNumber=${encodeURIComponent(adm)}`);
                if (!response.ok) throw new Error("Server Error");
                
                const data = await response.json();
                const claims = Array.isArray(data) ? data : [];
                let name =''
                 if(claims){
                    claims.forEach(c=>{
                        name = c.name
                    })
                }

                if (claims.length === 0) {
                    results.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-circle-exclamation fa-2x"></i>
                            <div>
                                <strong style="display:block">No records found</strong>
                                <small>No claims are currently associated with ${adm}.</small>
                            </div>
                        </div>
                    `;
                } else {
                    renderClaims(claims, name);
                }
            } catch (err) {
                results.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-triangle-exclamation fa-2x"></i>
                        <div>
                            <strong style="display:block">Network Error</strong>
                            <small>Unable to connect to the portal. Please try again later.</small>
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btnText.innerText = "Fetch Records";
                btnIcon.className = "fas fa-magnifying-glass";
            }
        });

        function renderClaims(claims, name) {
            const resultsArea = document.getElementById('resultsArea');
            resultsArea.innerHTML = `<h2><i class="fas fa-list-check"></i> Found ${claims.length} Claim(s) for ${name}</h2>`;

            claims.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at)).forEach(claim => {
                name = claim.name
                
                const session = (claim.session || 'NORMAL').toUpperCase();
                const card = document.createElement('div');
                card.className = 'claim-card';
                
                const dateStr = claim.submitted_at 
                    ? new Date(claim.submitted_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })
                    : 'Processing';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="meta-item">
                            <span class="meta-label"><i class="fas fa-hashtag"></i> Reference</span>
                            <span class="meta-value">${claim.reference_id || 'REF-TBD'}</span>
                        </div>
                        <div class="meta-item" style="text-align:right">
                            <span class="meta-label"><i class="fas fa-calendar-days"></i> Filed On</span>
                            <span class="meta-value">${dateStr}</span>
                        </div>
                    </div>
                    <div class="subject-body">
                        <div class="subject-main">
                            <h3><i class="fas fa-book-open"></i> ${claim.course_code}</h3>
                            <p class="subject-desc">${claim.course_title || 'Untitled Course'}</p>
                            <div class="lecturer-tag">
                                <i class="fas fa-user-tie"></i>
                                ${claim.lecturer_name || 'Department Head'}
                            </div>
                        </div>
                        <div class="status-badge cl-${session.toLowerCase()}">
                            <i class="fas fa-tag"></i>
                            ${session}
                        </div>
                    </div>
                `;
                resultsArea.appendChild(card);
                
            });
        }
    </script>
    <footer>
        <p style="color: #94a3b8; font-size: 0.85rem;">&copy; 2026 <a href="https://lutan-tech.is-great.org/?utm_source=missing_marks&utm_medium=direct" target="_blank">Lutan Tech</a></p>
        <div class="flag-line">
            <div style="flex:1; background:black"></div>
            <div style="flex:1; background:var(--kenya-red)"></div>
            <div style="flex:1; background:var(--deep-green)"></div>
        </div>
        <hr>
        <div class="version">Version 2.0.0. View <a href="/releases">Changelog</a></div>
    
    </footer>
</body>

</html>